{"version":3,"sources":["../src/message.js"],"names":["serialize","parse","makeKey","response","RESTPARAMS","FIELDS","KEYFIELDS","Message","constructor","type","args","fields","i","field","params","length","curArg","eqPos","indexOf","substr","msg","ret","param","push","undefined","join","str","split","map","orig","processed","retval","name","id"],"mappings":"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","file":"message.js","sourcesContent":["import { unescape, escape } from './util';\n\nconst RESTPARAMS = '___RESTARGS___';\n\nconst FIELDS = {\n  '%%>message': ['id', 'time', 'name', 'retvalue', RESTPARAMS],\n  '%%<message': ['id', 'processed', 'name', 'retvalue', RESTPARAMS],\n  '%%>install': ['prio', 'name', 'filterName', 'filterVal'],\n  '%%<install': ['prio', 'name', 'success'],\n  '%%>uninstall': ['name'],\n  '%%<uninstall': ['prio', 'name', 'success'],\n  '%%>watch': ['name'],\n  '%%<watch': ['name', 'success'],\n  '%%>setlocal': ['name', 'value'],\n  '%%>unwatch': ['name'],\n  '%%<unwatch': ['name', 'success'],\n  '%%<setlocal': ['name', 'value', 'success'],\n  '%%>connect': ['role', 'id', 'chanType'],\n  '%%>output': ['text'],\n  'Error in': ['text']\n};\n\nconst KEYFIELDS = {\n  '%%>message': ['id'],\n  '%%<message': ['id'],\n  '%%>setlocal': ['name'],\n  '%%<setlocal': ['name'],\n  '%%>install': ['name', 'prio'],\n  '%%<install': ['name', 'prio'],\n  '%%>watch': ['name'],\n  '%%<unwatch': ['name']\n};\n\n\nexport class Message {\n  constructor(type, ...args) {\n    const fields = FIELDS[type];\n    let i = 0;\n    for (const field of fields) {\n      if (field === RESTPARAMS) {\n        if (typeof args[i] !== 'string') {\n          this.params = args[i];\n          break;\n        }\n\n        this.params = {};\n        while (i < args.length) {\n          const curArg = args[i++];\n          const eqPos = curArg.indexOf('=');\n          this.params[curArg.substr(0, eqPos)] = curArg.substr(eqPos + 1);\n        }\n      } else {\n        this[field] = args[i++];\n      }\n    }\n    this.type = type;\n  }\n}\n\nexport function serialize(msg) {\n  const fields = FIELDS[msg.type];\n  const ret = [msg.type];\n\n  for (const field of fields) {\n    if (field === RESTPARAMS) {\n      for (const param of Object.keys(msg.params)) {\n        ret.push(`${escape(param)}=${escape(msg.params[param])}`);\n      }\n    } else if (msg[field] === undefined) {\n      ret.push('');\n    } else {\n      ret.push(escape(msg[field]));\n    }\n  }\n\n  return `${ret.join(':')}`;\n}\n\nexport function parse(str) {\n  const [type, ...args] = str.split(':');\n  return new Message(type, ...args.map(unescape));\n}\n\nexport function makeKey(msg) {\n  const fields = KEYFIELDS[msg.type];\n\n\n  if (KEYFIELDS[msg.type] === undefined) {\n    return undefined;\n  }\n  const ret = [msg.type.substr(3)];\n\n  for (const field of fields) {\n    ret.push(msg[field]);\n  }\n\n  return ret.join(':');\n}\n\nexport function response(orig, processed = true, retval = undefined, params = {}, name = undefined) {\n  return new Message(\n    '%%<message',\n    orig.id,\n    processed,\n    name === undefined ? orig.name : name,\n    retval === undefined ? orig.retval : retval,\n    params\n  );\n}\n"]}